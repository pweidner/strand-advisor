# strand-advisor v1.0 — In silico Strand-seq ground-truth generator (VISOR wrapper)

`strand-advisor` is a lightweight command-line wrapper around **VISOR** that generates **in silico Strand-seq BAMs** with:

- **Haplotype-specific SV truth** (via `VISOR HACk`)
- **Strand-seq simulation** (via `VISOR SHORtS --strandseq`)
- **Random inheritance states** per cell (**WW / WC / CW / CC**)
- **Sparse haplotagging** (HP tags on a subset of reads, controlled by `--hp-density`)
- **Reference (negative control) cells** generated by VISOR (`--refcells`)

The tool is designed for **HPC workflows** where:
- the **repo** lives in a stable location (e.g. home/work)
- large **shared assets** (reference FASTA, SNP-site BEDs) live in a shared project directory
- each run outputs into a **scratch run directory** and is fully self-contained

---

## 1) Conceptual workflow (step-by-step)

### 1.1 Inputs you provide per run
You typically provide:

1) **Regions BED** (where to simulate reads)
2) **SV BEDs for HACk** (one BED per haplotype: h1 and h2)
3) **# cells** to simulate (+ optional # reference cells)
4) Optional haplotagging parameters

> Important: `strand-advisor` assumes your **regions BED coordinates are in reference coordinates** (GRCh38 contigs like `chr1`, `chr2`, …).

---

### 1.2 What happens inside `strand-advisor`

#### Step A — Prepare a run folder
Given `--out OUTDIR`, the tool creates:

```
OUTDIR/
  config/        (future: run logs, resolved config)
  inputs/        (copied input region + SV beds)
  truth/         (SNP sites used for HP tagging + inheritance ledger)
  hack/          (HACk output haplotype FASTAs)
  visor_raw/     (SHORtS raw per-cell outputs)
  bam/           (final merged per-cell BAMs)
```

This makes each run reproducible and portable: the exact inputs are copied into `OUTDIR/inputs`.

---

#### Step B — Validate SVs lie within the region(s)
Before simulation, `strand-advisor` checks that each SV interval in your SV beds is fully contained in one of the regions specified in `--regions`.

If an SV falls outside your simulation region, the run fails early with a clear error.

---

#### Step C — Generate SV-only haplotypes (VISOR HACk)
If you provide `--sv-h1` and `--sv-h2`, the tool runs:

- `VISOR HACk -g REF_FASTA -b sv.h1.bed sv.h2.bed -o OUTDIR/hack`

This produces haplotype FASTAs:

- `OUTDIR/hack/h1.fa`
- `OUTDIR/hack/h2.fa`

These haplotypes represent the **truth genome** for SV simulation (SVs are physically embedded into the sequence).

> You can also skip HACk and provide `--hack PATH/TO/hack.out` if you already have haplotypes.

---

#### Step D — Simulate Strand-seq reads (VISOR SHORtS)
The tool then runs:

- `VISOR SHORtS --strandseq`

pointing to:
- the **reference FASTA** for mapping coordinates
- the **HACk output folder** as the sample haplotypes
- your **regions BED** to define where reads are simulated

VISOR writes raw per-cell BAMs under:

- `OUTDIR/visor_raw/sample_cellX/h1/{W.srt.bam,C.srt.bam}`
- `OUTDIR/visor_raw/sample_cellX/h2/{W.srt.bam,C.srt.bam}`
- and similarly for `reference_cellX` if `--refcells` > 0

---

#### Step E — Random inheritance state assignment (WW/WC/CW/CC)
For each generated cell, the wrapper chooses a random inheritance state per chromosome (uniform among):

- **WW**: Watson on both haplotypes
- **CC**: Crick on both haplotypes
- **WC**: Watson on h1, Crick on h2
- **CW**: Crick on h1, Watson on h2

This is recorded in:

- `OUTDIR/truth/inheritance_states.tsv`

Then the wrapper selects the appropriate per-haplotype (W/C) BAMs and merges them into one per cell.

---

#### Step F — Sparse haplotagging (HP tags)
Real Strand-seq data often has **sparse haplotag information** (only a fraction of reads carry HP tags).

`strand-advisor` models this in a **site-driven** way:

1) Takes haplotype-informative SNP sites from two BED files (h1 and h2).
2) Downsamples sites using `--hp-density` (0–1).
3) Haplotags reads **only if they overlap a kept SNP site**:
   - reads overlapping HP1 sites get `HP:i:1`
   - reads overlapping HP2 sites get `HP:i:2`

The downsampled site sets are saved for provenance:

- `OUTDIR/truth/hp_sites.HP1.bed`
- `OUTDIR/truth/hp_sites.HP2.bed`

> `--hp-density` is a proxy for “fraction of reads tagged”. The exact fraction depends on read length/coverage/SNP density.

---

#### Step G — Final outputs
For each cell, the tool writes:

- `OUTDIR/bam/<cellname>.bam.htg`
- `OUTDIR/bam/<cellname>.bam.htg.bai`

Where `<cellname>` is e.g. `sample_cell1`, `reference_cell2`, …

These `.bam.htg` outputs are convenient for downstream tools that expect haplotagged BAM naming.

---

## 2) Requirements

### 2.1 Software
You need:

- `VISOR` (tested with 1.1.x)
- `samtools`
- `python3`
- standard Unix tools: `awk`, `shuf`

On many HPC systems you’ll load these via modules or a conda env.

### 2.2 Reference FASTA
You must provide a reference FASTA and index:

- `REF_FASTA=/path/to/GRCh38_full_analysis_set_plus_decoy_hla.fa`
- and `REF_FASTA.fai` (auto-generated if missing)

---

## 3) Install / Setup

### 3.1 Clone
```bash
git clone https://github.com/<YOUR_ORG_OR_USER>/strand-advisor.git
cd strand-advisor
```

### 3.2 Put `strand-advisor` on your PATH
Add to `~/.bashrc`:

```bash
# strand-advisor CLI
STRAND_ADVISOR_HOME=/data/cephfs-1/home/users/<YOU>/work/strand-advisor
export PATH="$STRAND_ADVISOR_HOME/bin:$PATH"
```

Reload:

```bash
source ~/.bashrc
```

Verify:

```bash
which strand-advisor
strand-advisor --help
```

---

## 4) Configuration model (recommended for HPC)

### 4.1 Repo location (stable)
Example:
- Repo lives here (long-term):  
  `/data/cephfs-1/home/users/pweidne_m/work/strand-advisor`

### 4.2 Shared assets (large, shared)
Example:
- Shared references & SNP sites live here:  
  `/data/cephfs-1/work/groups/sanders/strand-advisor-assets`

### 4.3 Run outputs (scratch)
Example:
- Each run goes to scratch:  
  `/data/cephfs-1/scratch/groups/sanders/kiwi_tmp/advisor-beta`

### 4.4 `config/defaults.env`
`strand-advisor` sources `config/defaults.env` automatically.

Keep it portable and small. A typical pattern is to **set `REF_FASTA` in your shell**:

```bash
export REF_FASTA=/data/cephfs-1/work/groups/sanders/strand-advisor-assets/refs/GRCh38_full_analysis_set_plus_decoy_hla.fa
```

Then runs can be executed from anywhere.

---

## 5) Input file formats + how to generate them

### 5.1 Regions BED (VISOR SHORtS)
Must be **tab-delimited** with **≥5 columns**:

```
chrom   start   end   hap%   clone%
```

- Coordinates are **1-based start** in many VISOR examples; in practice, keep consistent with your other inputs.
- `hap%` and `clone%` are used by VISOR; for simple use, set both to `100.0`.

**Example: chr1 1–50Mb**
```bash
cat > regions.chr1_50Mb.bed <<'EOF'
chr1	1	50000000	100.0	100.0
EOF

cat -A regions.chr1_50Mb.bed
```

You should see tabs (`^I`) and a trailing `$`.

---

### 5.2 SV BED for VISOR HACk (BED6 “BED-like”)
HACk expects **6 columns**:

```
chrom   start   end   variant_type   payload   hap%
```

Examples:
- deletion:
  - `variant_type`: `deletion`
  - `payload`: `None`
- tandem duplication:
  - `variant_type`: `tandem duplication`
  - `payload`: integer copy count, e.g. `2`
- inversion:
  - `variant_type`: `inversion`
  - `payload`: `None`

> Note: `tandem duplication` has a space — do **not** use `tandem_duplication`.

#### Example 1: haplotype 1 tandem duplication at 30–40Mb
```bash
cat > sv.chr1_dup30_40.h1.bed <<'EOF'
chr1	30000000	40000000	tandem duplication	2	0
EOF
```

#### Example 2: haplotype 2 deletion at 10–14Mb
```bash
cat > sv.chr1_del10_14.h2.bed <<'EOF'
chr1	10000000	14000000	deletion	None	0
EOF
```

#### Make a “no SV” haplotype file
```bash
: > sv.empty.h2.bed
```

Validate formatting:
```bash
cat -A sv.chr1_dup30_40.h1.bed
cat -A sv.chr1_del10_14.h2.bed
```

---

## 6) Run examples

### 6.1 Minimal test (chr1, 50Mb, 4 cells, 1 reference cell)
From anywhere, with `REF_FASTA` set:

```bash
OUT=/data/cephfs-1/scratch/groups/sanders/kiwi_tmp/advisor-beta

strand-advisor \
  --cells 4 \
  --refcells 1 \
  --regions /data/cephfs-1/scratch/groups/sanders/kiwi_tmp/input-advisor/regions.chr1_50Mb.bed \
  --sv-h1 /data/cephfs-1/scratch/groups/sanders/kiwi_tmp/input-advisor/sv.chr1_dup30_40.h1.bed \
  --sv-h2 /data/cephfs-1/scratch/groups/sanders/kiwi_tmp/input-advisor/sv.chr1_dup30_40.h2.bed \
  --hp-density 0.2 \
  --snp-sample HG00732 \
  --out "$OUT"
```

Expected output files:

```bash
ls -lah "$OUT/bam"
```

You should see:

- `sample_cell*.bam.htg` (+ `.bai`)
- `reference_cell*.bam.htg` (+ `.bai`)

---

### 6.2 Quick sanity checks

#### Check inheritance ledger
```bash
column -t "$OUT/truth/inheritance_states.tsv" | head
```

#### Check HP tags exist (sparse)
```bash
bam="$OUT/bam/sample_cell1.bam.htg"
samtools view "$bam" | grep -c $'\tHP:i:' || true
samtools view "$bam" | wc -l
```

#### Check SV signal roughly via depth (example: chr1:30–40Mb duplication)
```bash
samtools depth -r chr1:29000000-30000000 "$bam" | awk '{s+=$3;n++} END{print "pre",s/n}'
samtools depth -r chr1:30000000-40000000 "$bam" | awk '{s+=$3;n++} END{print "dup",s/n}'
samtools depth -r chr1:40000000-41000000 "$bam" | awk '{s+=$3;n++} END{print "post",s/n}'
```

You typically expect higher depth inside the duplication window relative to flanks (coverage-dependent).

---

## 7) Notes / gotchas

### 7.1 Coordinate shifts for length-changing SVs
Length-changing SVs (duplications/insertions) can shift haplotype coordinates relative to reference.
If you notice “empty tails” after a duplication, this is usually due to reference-coordinate regions being applied to haplotype FASTA coordinates after insertion. A common mitigation strategy is region padding + trimming (planned enhancement).

### 7.2 HP tag density
`--hp-density` downsamples **SNP sites**, not reads directly. The resulting fraction of HP-tagged reads depends on:
- SNP density
- read length
- coverage

Tune empirically.

### 7.3 Reference cells
VISOR generates `reference_cell*` when `--refcells` is set; `strand-advisor` post-processes both `sample_cell*` and `reference_cell*` into final BAMs.

---

## 8) Versioning
This README corresponds to **strand-advisor v1.0**.

If you plan to publish a release, consider:
- tagging: `git tag -a v1.0 -m "strand-advisor v1.0"`
- pushing tags: `git push --tags`

---

## 9) Where to look if something fails

- `OUTDIR/hack/` — haplotype FASTAs created?
- `OUTDIR/visor_raw/` — raw per-cell W/C BAMs created?
- `OUTDIR/bam/` — final merged `.bam.htg` produced?

If something fails mid-run, these directories help pinpoint whether the issue is in HACk, SHORtS, or post-processing.

---

Happy benchmarking!
