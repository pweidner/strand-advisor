#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$ROOT/lib/common.sh"

need VISOR
need samtools
need awk
need shuf
need python3

###############################################################################
# Usage
###############################################################################
usage() {
cat <<EOF
strand-advisor

Generate Strand-seq ground truth datasets with SVs, inheritance states,
reference control cells, and sparse haplotags.

Required:
  --cells N
  --regions REGIONS.bed
  --out OUTDIR

One of:
  --hack HACk_DIR                 (use existing haplotypes)
  --sv-h1 SV_H1.bed --sv-h2 SV_H2.bed   (auto-run HACk)

Optional:
  --refcells N
  --hp-density FLOAT              (0–1, default 1.0)
  --snp-h1 BED
  --snp-h2 BED
  --snp-sample NAME               (default HG00732)

Environment:
  REF_FASTA   (required)
  CHROMS_FILE (optional, defaults to config/chroms.grch38.txt)

EOF
}

###############################################################################
# Defaults
###############################################################################
CELLS=""
REFCELLS=0
OUT=""
REGIONS=""
SV_H1=""
SV_H2=""
HACK_DIR=""
HP_DENSITY=1.0
SNP_SAMPLE="HG00732"
SNP_H1=""
SNP_H2=""

###############################################################################
# Parse args
###############################################################################
while [[ $# -gt 0 ]]; do
  case "$1" in
    --cells) CELLS="$2"; shift 2;;
    --refcells) REFCELLS="$2"; shift 2;;
    --regions) REGIONS="$2"; shift 2;;
    --sv-h1) SV_H1="$2"; shift 2;;
    --sv-h2) SV_H2="$2"; shift 2;;
    --hack) HACK_DIR="$2"; shift 2;;
    --hp-density) HP_DENSITY="$2"; shift 2;;
    --snp-h1) SNP_H1="$2"; shift 2;;
    --snp-h2) SNP_H2="$2"; shift 2;;
    --snp-sample) SNP_SAMPLE="$2"; shift 2;;
    --out) OUT="$2"; shift 2;;
    -h|--help) usage; exit 0;;
    *) die "Unknown argument: $1";;
  esac
done

###############################################################################
# Validate basic inputs
###############################################################################
[ -n "$CELLS" ] || die "--cells required"
[ -n "$OUT" ] || die "--out required"
[ -n "$REGIONS" ] || die "--regions required"
[ -f "$REGIONS" ] || die "Regions BED not found"

[ -n "${REF_FASTA:-}" ] || die "REF_FASTA environment variable not set"
[ -f "$REF_FASTA" ] || die "REF_FASTA not found"
[ -f "$REF_FASTA.fai" ] || samtools faidx "$REF_FASTA"

awk -v p="$HP_DENSITY" 'BEGIN{ if(p<0||p>1) exit 1 }' || die "--hp-density must be 0–1"

###############################################################################
# Prepare run directory
###############################################################################
mkdir -p "$OUT"/{config,inputs,truth,hack,visor_raw,final_cells}

cp "$REGIONS" "$OUT/inputs/regions.bed"
REGIONS="$OUT/inputs/regions.bed"

###############################################################################
# Validate regions BED (>=5 columns)
###############################################################################
awk 'NF<5{exit 1}' "$REGIONS" || die "Regions BED must have ≥5 columns"

###############################################################################
# SV ⊂ region validation
###############################################################################
validate_sv_in_region () {
  local sv="$1"
  awk 'NR==FNR{r[$1,$2,$3]=1; next}
       {
         ok=0
         for (k in r) {
           split(k,a,SUBSEP)
           if ($1==a[1] && $2>=a[2] && $3<=a[3]) ok=1
         }
         if (!ok) {
           print "[ERROR] SV not fully contained in region:", $0 > "/dev/stderr"
           exit 1
         }
       }' "$REGIONS" "$sv"
}

###############################################################################
# Determine haplotypes (auto-HACk if needed)
###############################################################################
if [ -n "$HACK_DIR" ]; then
  [ -d "$HACK_DIR" ] || die "HACk dir not found"
elif [ -n "$SV_H1" ] && [ -n "$SV_H2" ]; then
  [ -f "$SV_H1" ] || die "SV h1 BED not found"
  [ -f "$SV_H2" ] || die "SV h2 BED not found"

  cp "$SV_H1" "$OUT/inputs/sv.h1.bed"
  cp "$SV_H2" "$OUT/inputs/sv.h2.bed"

  validate_sv_in_region "$OUT/inputs/sv.h1.bed"
  validate_sv_in_region "$OUT/inputs/sv.h2.bed"

  echo "[INFO] Running HACk (SV-only)"
  VISOR HACk \
    -g "$REF_FASTA" \
    -b "$OUT/inputs/sv.h1.bed" "$OUT/inputs/sv.h2.bed" \
    -o "$OUT/hack"

  HACK_DIR="$OUT/hack"
else
  die "Provide either --hack or both --sv-h1/--sv-h2"
fi

###############################################################################
# Resolve SNP beds for HP tagging
###############################################################################
if [ -z "$SNP_H1" ]; then
  SNP_H1="$ROOT/examples/${SNP_SAMPLE}.snps.h1.bed"
fi
if [ -z "$SNP_H2" ]; then
  SNP_H2="$ROOT/examples/${SNP_SAMPLE}.snps.h2.bed"
fi

[ -f "$SNP_H1" ] || die "SNP h1 BED not found"
[ -f "$SNP_H2" ] || die "SNP h2 BED not found"

###############################################################################
# Downsample informative SNP sites
###############################################################################
HP1_SITES="$OUT/truth/hp_sites.HP1.bed"
HP2_SITES="$OUT/truth/hp_sites.HP2.bed"

awk -v p="$HP_DENSITY" 'BEGIN{srand()} rand()<p{print}' "$SNP_H1" > "$HP1_SITES"
awk -v p="$HP_DENSITY" 'BEGIN{srand()} rand()<p{print}' "$SNP_H2" > "$HP2_SITES"

###############################################################################
# Run VISOR SHORtS
###############################################################################
echo "[INFO] Running VISOR SHORtS"
VISOR SHORtS \
  -g "$REF_FASTA" \
  -s "$HACK_DIR" \
  -b "$REGIONS" \
  -o "$OUT/visor_raw" \
  --strandseq \
  --cells "$CELLS" \
  --refcells "$REFCELLS"

###############################################################################
# Inheritance + sparse HP tagging
###############################################################################
echo -e "cell\tchrom\tstate" > "$OUT/truth/inheritance_states.tsv"
states=(WW WC CW CC)

for cell in "$OUT/visor_raw"/sample_cell*; do
  cname=$(basename "$cell")
  tmp=$(mktemp -d)

  while read -r chr _; do
    state=$(printf "%s\n" "${states[@]}" | shuf -n1)
    echo -e "$cname\t$chr\t$state" >> "$OUT/truth/inheritance_states.tsv"

    case "$state" in
      WW) b1="$cell/h1/W.srt.bam"; b2="$cell/h2/W.srt.bam";;
      CC) b1="$cell/h1/C.srt.bam"; b2="$cell/h2/C.srt.bam";;
      WC) b1="$cell/h1/W.srt.bam"; b2="$cell/h2/C.srt.bam";;
      CW) b1="$cell/h1/C.srt.bam"; b2="$cell/h2/W.srt.bam";;
    esac

    samtools view -h "$b1" "$chr" \
      | "$ROOT/lib/tag_hp_sparse.py" --sites "$HP1_SITES" --hp 1 \
      | samtools view -b -o "$tmp/${chr}.h1.bam" -

    samtools view -h "$b2" "$chr" \
      | "$ROOT/lib/tag_hp_sparse.py" --sites "$HP2_SITES" --hp 2 \
      | samtools view -b -o "$tmp/${chr}.h2.bam" -
  done < <(awk '{print $1}' "$REGIONS")

  samtools merge -f "$tmp/merged.bam" "$tmp"/*.bam
  samtools sort -o "$OUT/final_cells/$cname.bam" "$tmp/merged.bam"
  samtools index "$OUT/final_cells/$cname.bam"

  rm -rf "$tmp"
done

echo "[DONE] Output written to $OUT"
