#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/lib.sh"

need VISOR
need samtools
need awk
need shuf

DEFAULTS_FILE=${DEFAULTS_FILE:-config/defaults.env}
[ -f "$DEFAULTS_FILE" ] || die "Defaults file not found: $DEFAULTS_FILE"
# shellcheck disable=SC1090
source "$DEFAULTS_FILE"

make_active_chroms () {
  local chroms_file="$1"
  local ref_fai="$2"
  local hack_dir="$3"
  local out_file="$4"

  [ -f "$chroms_file" ] || die "CHROMS_FILE not found: $chroms_file"
  [ -f "$ref_fai" ] || die "Reference index not found: $ref_fai"

  [ -f "$hack_dir/h1.fa" ] || die "Missing $hack_dir/h1.fa"
  [ -f "$hack_dir/h1.fa.fai" ] || samtools faidx "$hack_dir/h1.fa"

  if [ -f "$hack_dir/h2.fa" ] && [ ! -f "$hack_dir/h2.fa.fai" ]; then
    samtools faidx "$hack_dir/h2.fa"
  fi

  cut -f1 "$ref_fai" | sort -u > "$out_file.ref"
  cut -f1 "$hack_dir/h1.fa.fai" | sort -u > "$out_file.hap"
  if [ -f "$hack_dir/h2.fa.fai" ]; then
    cut -f1 "$hack_dir/h2.fa.fai" | sort -u >> "$out_file.hap"
    sort -u "$out_file.hap" -o "$out_file.hap"
  fi
  awk 'NF{print $1}' "$chroms_file" | sort -u > "$out_file.cfg"

  comm -12 <(comm -12 "$out_file.cfg" "$out_file.ref") "$out_file.hap" > "$out_file"

  rm -f "$out_file.ref" "$out_file.hap" "$out_file.cfg"
  [ -s "$out_file" ] || die "No overlapping chromosomes between CHROMS_FILE, reference, and haplotypes. Check naming (chr1 vs 1)."
}

usage() {
  cat <<USAGE
Usage:
  scripts/run_strandseq.sh --cells N --hack /path/to/hack.out [--refcells R] [--regions BED] [--hp-density 0.2] [--out results/run1]

Required:
  --cells       Number of single cells to simulate
  --hack        HACk output directory containing SV-only haplotypes (h1.fa, h2.fa)

Optional:
  --refcells    Number of reference diploid cells among --cells (negative controls). Default: 0
  --regions     Regions BED for VISOR SHORtS (>=5 columns: chrom start end hap% clone%)
  --hp-density  Fraction of informative SNP sites to keep for tagging (default: 1.0)
               (Proxy for "fraction of reads tagged"; tune to hit ~20% reads.)
  --snp-sample  Sample name for SNP-site source (default: HG00732)
  --snp-h1      Source SNP BED for hap1 (overrides --snp-sample)
  --snp-h2      Source SNP BED for hap2 (overrides --snp-sample)
  --out         Output run directory (default: results/run_\$(date +%Y%m%d_%H%M%S))

Environment overrides:
  REF_FASTA, CHROMS_FILE, COVERAGE, NOISE, THREADS
USAGE
}

CELLS=""
REFCELLS="0"
HACK_DIR=""
OUT_RUN=""
REGIONS_OVERRIDE=""
HP_DENSITY="1.0"
SNP_SAMPLE="HG00732"
SNP_H1=""
SNP_H2=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --cells)      CELLS="$2"; shift 2;;
    --refcells)   REFCELLS="$2"; shift 2;;
    --hack)       HACK_DIR="$2"; shift 2;;
    --regions)    REGIONS_OVERRIDE="$2"; shift 2;;
    --hp-density) HP_DENSITY="$2"; shift 2;;
    --snp-sample) SNP_SAMPLE="$2"; shift 2;;
    --snp-h1)     SNP_H1="$2"; shift 2;;
    --snp-h2)     SNP_H2="$2"; shift 2;;
    --out)        OUT_RUN="$2"; shift 2;;
    -h|--help) usage; exit 0;;
    *) die "Unknown argument: $1 (use --help)";;
  esac
done

[ -n "$CELLS" ] || die "--cells is required"
[ -n "$HACK_DIR" ] || die "--hack is required"
[ -d "$HACK_DIR" ] || die "HACk directory not found: $HACK_DIR"
[ -f "$HACK_DIR/h1.fa" ] || die "Expected $HACK_DIR/h1.fa"
[ -f "$HACK_DIR/h2.fa" ] || die "Expected $HACK_DIR/h2.fa (SV benchmarking assumes diploid haplotypes)"
[ -f "$REF_FASTA" ] || die "REF_FASTA not found: $REF_FASTA (edit config/defaults.env or set REF_FASTA)"
[ -f "${REF_FASTA}.fai" ] || samtools faidx "$REF_FASTA"

# validate numeric args
awk -v n="$CELLS" 'BEGIN{ if(n<1) exit 1 }' || die "--cells must be >=1"
awk -v r="$REFCELLS" -v n="$CELLS" 'BEGIN{ if(r<0 || r>n) exit 1 }' || die "--refcells must be between 0 and --cells"
awk -v p="$HP_DENSITY" 'BEGIN{ if(p<0 || p>1) exit 1 }' || die "--hp-density must be between 0 and 1"

OUT_RUN=${OUT_RUN:-results/run_$(date +%Y%m%d_%H%M%S)}
RAW_OUT="$OUT_RUN/raw_visor"
FINAL_OUT="$OUT_RUN/final_cells"
REGIONS_BED="$OUT_RUN/regions.bed"
LEDGER="$OUT_RUN/inheritance_states.tsv"
HP1_SITES="$OUT_RUN/hp_sites.HP1.bed"
HP2_SITES="$OUT_RUN/hp_sites.HP2.bed"

mkdir -p "$RAW_OUT" "$FINAL_OUT"

ACTIVE_CHROMS="$OUT_RUN/active_chroms.txt"
make_active_chroms "$CHROMS_FILE" "${REF_FASTA}.fai" "$HACK_DIR" "$ACTIVE_CHROMS"
echo "[OK] Active chroms (from ref+hap+config): $(wc -l < "$ACTIVE_CHROMS") (written to $ACTIVE_CHROMS)"

if [ -n "$REGIONS_OVERRIDE" ]; then
  [ -f "$REGIONS_OVERRIDE" ] || die "Regions BED not found: $REGIONS_OVERRIDE"
  awk 'NF{ if (NF<5) exit 1; else exit 0 } END{ if(NR==0) exit 1 }' "$REGIONS_OVERRIDE" \
    || die "Regions BED must have at least 5 columns and not be empty: $REGIONS_OVERRIDE"
  REGIONS_BED="$REGIONS_OVERRIDE"
  echo "[OK] Using regions BED override: $REGIONS_BED"

  REG_CHROMS="$OUT_RUN/regions.chroms.txt"
  awk 'NF{print $1}' "$REGIONS_BED" | sort -u > "$REG_CHROMS"
  comm -12 <(sort -u "$ACTIVE_CHROMS") "$REG_CHROMS" > "$OUT_RUN/active_chroms.from_regions.txt"
  mv "$OUT_RUN/active_chroms.from_regions.txt" "$ACTIVE_CHROMS"
  [ -s "$ACTIVE_CHROMS" ] || die "After applying regions BED, no active chromosomes remain. Check contig names."
  echo "[OK] Active chroms (after regions filter): $(wc -l < "$ACTIVE_CHROMS")"
else
  : > "$REGIONS_BED"
  while read -r chr; do
    [ -z "$chr" ] && continue
    len=$(awk -v c="$chr" '$1==c{print $2}' "${REF_FASTA}.fai")
    [ -n "$len" ] || die "Chromosome $chr not found in reference index ${REF_FASTA}.fai"
    printf "%s\t1\t%s\t100.0\t100.0\n" "$chr" "$len" >> "$REGIONS_BED"
  done < "$ACTIVE_CHROMS"
  echo "[OK] Regions BED (auto): $REGIONS_BED"
fi

# SNP sites for HP tagging (Mode A): independent of simulated genome sequence
if [ -z "$SNP_H1" ] || [ -z "$SNP_H2" ]; then
  SNP_H1=${SNP_H1:-"data/variants/hack_snp_beds/${SNP_SAMPLE}.snps.h1.bed"}
  SNP_H2=${SNP_H2:-"data/variants/hack_snp_beds/${SNP_SAMPLE}.snps.h2.bed"}
fi
[ -f "$SNP_H1" ] || die "SNP hap1 BED not found: $SNP_H1 (use --snp-h1 or --snp-sample)"
[ -f "$SNP_H2" ] || die "SNP hap2 BED not found: $SNP_H2 (use --snp-h2 or --snp-sample)"

echo "[INFO] Building downsampled informative HP sites (density=$HP_DENSITY, SNP sample=$SNP_SAMPLE)"

filter_and_downsample_sites () {
  local in_bed="$1"
  local out_bed="$2"
  awk -v OFS="\t" -v p="$HP_DENSITY" '
    BEGIN{ srand(); }
    FNR==NR {
      if($0 ~ /^#/ || NF<3) next
      rc[$1]++
      rstart[$1,rc[$1]]=$2
      rend[$1,rc[$1]]=$3
      next
    }
    {
      chrom=$1; s=$2; e=$3
      if(!(chrom in rc)) next
      ok=0
      for(i=1;i<=rc[chrom];i++){
        rs=rstart[chrom,i]; re=rend[chrom,i]
        if(s < re && e > rs){ ok=1; break }
      }
      if(!ok) next
      if(rand() < p) print $1,$2,$3
    }
  ' "$REGIONS_BED" "$in_bed" > "$out_bed"
}

tmp_h1="$OUT_RUN/_tmp.h1.sites.bed"
tmp_h2="$OUT_RUN/_tmp.h2.sites.bed"
grep -Fwf "$ACTIVE_CHROMS" "$SNP_H1" > "$tmp_h1" || true
grep -Fwf "$ACTIVE_CHROMS" "$SNP_H2" > "$tmp_h2" || true

filter_and_downsample_sites "$tmp_h1" "$HP1_SITES"
filter_and_downsample_sites "$tmp_h2" "$HP2_SITES"
rm -f "$tmp_h1" "$tmp_h2"

echo "[OK] HP1 sites kept: $(wc -l < "$HP1_SITES") -> $HP1_SITES"
echo "[OK] HP2 sites kept: $(wc -l < "$HP2_SITES") -> $HP2_SITES"

echo "[INFO] Running VISOR SHORtS: cells=$CELLS refcells=$REFCELLS coverage=$COVERAGE noise=$NOISE threads=$THREADS"
VISOR SHORtS \
  -g "$REF_FASTA" \
  -s "$HACK_DIR" \
  -b "$REGIONS_BED" \
  -o "$RAW_OUT" \
  --strandseq \
  --cells "$CELLS" \
  --refcells "$REFCELLS" \
  --coverage "$COVERAGE" \
  --noise "$NOISE" \
  --threads "$THREADS"

echo -e "cell\tchrom\tstate" > "$LEDGER"
states=(WW WC CW CC)

pick_bam () {
  local cell="$1" state="$2" hap="$3"
  case "${state}_${hap}" in
    WW_h1) echo "$cell/h1/W.srt.bam";;
    WW_h2) echo "$cell/h2/W.srt.bam";;
    CC_h1) echo "$cell/h1/C.srt.bam";;
    CC_h2) echo "$cell/h2/C.srt.bam";;
    WC_h1) echo "$cell/h1/W.srt.bam";;
    WC_h2) echo "$cell/h2/C.srt.bam";;
    CW_h1) echo "$cell/h1/C.srt.bam";;
    CW_h2) echo "$cell/h2/W.srt.bam";;
    *) die "Bad state/hap: ${state}_${hap}";;
  esac
}

for cell in "$RAW_OUT"/sample_cell*; do
  [ -d "$cell" ] || continue
  cname=$(basename "$cell")
  echo "[INFO] Building inherited BAM for $cname"

  tmpdir=$(mktemp -d)
  trap 'rm -rf "$tmpdir"' EXIT
  chunks=()

  while read -r chrom; do
    [ -z "$chrom" ] && continue
    state=$(printf "%s\n" "${states[@]}" | shuf -n 1)
    echo -e "${cname}\t${chrom}\t${state}" >> "$LEDGER"

    h1bam=$(pick_bam "$cell" "$state" "h1")
    h2bam=$(pick_bam "$cell" "$state" "h2")
    [ -f "$h1bam" ] || die "Missing $h1bam"
    [ -f "$h2bam" ] || die "Missing $h2bam"

    out1="$tmpdir/${cname}.${chrom}.h1.bam"
    out2="$tmpdir/${cname}.${chrom}.h2.bam"

    samtools view -h "$h1bam" "$chrom" \
      | scripts/tag_hp_sparse.py --sites "$HP1_SITES" --hp 1 \
      | samtools view -b -o "$out1" -
    samtools view -h "$h2bam" "$chrom" \
      | scripts/tag_hp_sparse.py --sites "$HP2_SITES" --hp 2 \
      | samtools view -b -o "$out2" -

    chunks+=("$out1" "$out2")
  done < "$ACTIVE_CHROMS"

  outbam="$FINAL_OUT/${cname}.HP.srt.bam"
  samtools merge -f "$tmpdir/${cname}.merged.bam" "${chunks[@]}"
  samtools sort -o "$outbam" "$tmpdir/${cname}.merged.bam"
  samtools index "$outbam"

  rm -rf "$tmpdir"
  trap - EXIT
  echo "[OK] $outbam"
done

echo "[DONE] Raw VISOR:  $RAW_OUT"
echo "[DONE] Final BAMs: $FINAL_OUT"
echo "[DONE] Ledger:    $LEDGER"
echo "[DONE] HP sites:  $HP1_SITES and $HP2_SITES"